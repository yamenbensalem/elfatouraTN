<div class="commande-achat-detail-container">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading$ | async">
    <app-loading-spinner message="Chargement de la commande d'achat..."></app-loading-spinner>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="(error$ | async) as error">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <div class="error-actions">
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Retour à la liste
      </button>
      <button mat-raised-button color="primary" (click)="retry()">
        Réessayer
      </button>
    </div>
  </div>

  <!-- Commande Details -->
  <ng-container *ngIf="commande && !(loading$ | async) && !(error$ | async)">
    <!-- Page Header -->
    <app-page-header [title]="'Commande ' + commande.codeCommande" [subtitle]="'Fournisseur: ' + (commande.raisonSocialeFournisseur || commande.codeFournisseur)">
      <div actions>
        <button mat-stroked-button (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Retour
        </button>
        <button mat-stroked-button color="accent" (click)="editCommande()">
          <mat-icon>edit</mat-icon>
          Modifier
        </button>
        <button mat-stroked-button color="warn" (click)="deleteCommande()">
          <mat-icon>delete</mat-icon>
          Supprimer
        </button>
      </div>
    </app-page-header>

    <!-- Details Card -->
    <mat-card class="detail-card">
      <mat-card-content>

        <!-- Section: Informations Générales -->
        <div class="detail-section">
          <h3 class="section-title">
            <mat-icon>local_shipping</mat-icon>
            Informations Générales
          </h3>

          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Code Commande</span>
              <span class="value">{{ commande.codeCommande }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Date Commande</span>
              <span class="value">{{ commande.dateCommande | dateFr }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Fournisseur</span>
              <span class="value">{{ commande.raisonSocialeFournisseur || commande.codeFournisseur }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Statut</span>
              <span class="value">
                <span class="statut-chip" [ngClass]="getStatutClass(commande.statut)">
                  {{ commande.statut }}
                </span>
              </span>
            </div>

            <div class="detail-item">
              <span class="label">Date de Réception Prévue</span>
              <span class="value">{{ commande.dateReceptionPrevue ? (commande.dateReceptionPrevue | dateFr) : '-' }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Date Création</span>
              <span class="value">{{ commande.dateCreation | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>

        <!-- Section: Montants -->
        <div class="detail-section">
          <h3 class="section-title">
            <mat-icon>account_balance</mat-icon>
            Montants
          </h3>

          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Montant HT</span>
              <span class="value currency">{{ commande.montantHT | currencyTn }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Montant TVA</span>
              <span class="value currency">{{ commande.montantTVA | currencyTn }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Montant TTC</span>
              <span class="value currency total">{{ commande.montantTTC | currencyTn }}</span>
            </div>
          </div>
        </div>

        <!-- Section: Lignes de la Commande -->
        <div class="detail-section" *ngIf="commande.lignes && commande.lignes.length > 0">
          <h3 class="section-title">
            <mat-icon>list</mat-icon>
            Lignes de la Commande
          </h3>

          <table mat-table [dataSource]="commande.lignes" class="lignes-table">
            <ng-container matColumnDef="codeProduit">
              <th mat-header-cell *matHeaderCellDef>Code Produit</th>
              <td mat-cell *matCellDef="let ligne">{{ ligne.codeProduit }}</td>
            </ng-container>

            <ng-container matColumnDef="designation">
              <th mat-header-cell *matHeaderCellDef>Désignation</th>
              <td mat-cell *matCellDef="let ligne">{{ ligne.designation }}</td>
            </ng-container>

            <ng-container matColumnDef="quantite">
              <th mat-header-cell *matHeaderCellDef>Quantité</th>
              <td mat-cell *matCellDef="let ligne">{{ ligne.quantite }}</td>
            </ng-container>

            <ng-container matColumnDef="prixUnitaireHT">
              <th mat-header-cell *matHeaderCellDef>Prix Unitaire HT</th>
              <td mat-cell *matCellDef="let ligne" class="currency-cell">{{ ligne.prixUnitaireHT | currencyTn }}</td>
            </ng-container>

            <ng-container matColumnDef="tauxRemise">
              <th mat-header-cell *matHeaderCellDef>Remise (%)</th>
              <td mat-cell *matCellDef="let ligne">{{ ligne.tauxRemise }}%</td>
            </ng-container>

            <ng-container matColumnDef="montantHT">
              <th mat-header-cell *matHeaderCellDef>Montant HT</th>
              <td mat-cell *matCellDef="let ligne" class="currency-cell">{{ ligne.montantHT | currencyTn }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="lignesColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: lignesColumns;"></tr>
          </table>
        </div>

        <!-- Section: Notes -->
        <div class="detail-section" *ngIf="commande.notes">
          <h3 class="section-title">
            <mat-icon>note</mat-icon>
            Notes
          </h3>

          <div class="notes-content">
            {{ commande.notes }}
          </div>
        </div>

      </mat-card-content>
    </mat-card>
  </ng-container>
</div>
